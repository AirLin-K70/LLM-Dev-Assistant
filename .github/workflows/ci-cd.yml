name: AI-Bot CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯ï¼Œæˆ–æäº¤ Pull Request æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # === Job 1: ä»£ç è´¨é‡æ£€æŸ¥ä¸æµ‹è¯• (CI) ===
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: æ‹‰å–ä»£ç  (Checkout)
      uses: actions/checkout@v3

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ” è°ƒè¯• - æ‰“å°æ‰€æœ‰æ–‡ä»¶ç»“æ„
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -R

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…ç½‘å…³çš„ä¾èµ–ç”¨äºæµ‹è¯•
        pip install -r backend/gateway/requirements.txt
        pip install httpx pytest # æµ‹è¯•å·¥å…·

    - name: è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ (Lint)
      run: |
        # ç®€å•æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ (flake8 éœ€è¦å…ˆå®‰è£…ï¼Œè¿™é‡Œæ¼”ç¤ºç”¨ç®€å•çš„ç¼–è¯‘æ£€æŸ¥)
        python -m compileall backend/

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      # è®¾ç½® PYTHONPATH ç¡®ä¿èƒ½æ‰¾åˆ° config.py
      env:
        PYTHONPATH: ${{ github.workspace }}/backend/gateway
        INTERNAL_API_KEY: "test_key" # æ¨¡æ‹Ÿç¯å¢ƒå˜é‡
        SECRET_KEY: "test_secret"
      run: |
        pytest test/test_basic.py

  # === Job 2: æ„å»ºä¸éƒ¨ç½²æ¨¡æ‹Ÿ (CD) ===
  build-and-deploy:
    needs: test-and-lint # åªæœ‰æµ‹è¯•é€šè¿‡äº†æ‰æ‰§è¡Œè¿™ä¸€æ­¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: æ„å»º Docker é•œåƒ (Gateway)
      uses: docker/build-push-action@v4
      with:
        context: .
        file: backend/gateway/Dockerfile
        push: false # æ¼”ç¤ºé¡¹ç›®æš‚æ—¶ä¸æ¨é€åˆ° DockerHubï¼ŒåªéªŒè¯æ„å»ºæ˜¯å¦æˆåŠŸ
        tags: ai-gateway:latest

    - name: éªŒè¯ Docker Compose é…ç½®
      run: |
        # æ£€æŸ¥ docker-compose.yml è¯­æ³•æ˜¯å¦æ­£ç¡®
        docker compose config
      env:
        # æ³¨å…¥å¿…è¦çš„ç¯å¢ƒå˜é‡ç”¨äº config æ£€æŸ¥
        OPENAI_API_KEY: "sk-test"
        DB_PASSWORD: "test"
        SECRET_KEY: "test"
        INTERNAL_API_KEY: "test"
